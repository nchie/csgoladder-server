var socket_io     = require('socket.io');
var cookie        = require('cookie');
var jwt           = require('jsonwebtoken');
var redis         = require('socket.io-redis');

var io            = socket_io();

io.adapter(redis({ host: 'localhost', port: 6379 }));

module.exports = io;

io.use(function(socket, next) {
  // Parse the cookies and put them in socket.cookies
  if(socket.request.headers.cookie)
  {
    socket.cookies = cookie.parse(socket.request.headers.cookie);
  }
  next();
});

io.use(function(socket, next) {
  // If there's a valid access token (JWT) in the cookies, store it in socket.access_token

  if(socket.cookies.access_token)
    try {
      socket.validtoken = jwt.verify(socket.cookies.access_token, jwt.secret);
    } catch(err) {
      //Invalid token
    }

  next();
});


io.on('connection', function(socket){
  console.log('user connected');
  if(socket.validtoken)
  {
    console.log("User " + socket.validtoken.user + " joined room \"user:" + socket.validtoken.user + "\"")
    socket.join("user:" + socket.validtoken.user);
    socket.join("users");

    socket.on('GIVEMELOBBY', function(data){
      socket.emit('lobbyAdd', { name: 'Team6', rating: 1350, maps: "Any", description: "Mid-"})
    })

    /*socket.on('getLobbies', function(){
      socket.emit
    })*/

  }


  socket.on('disconnect', function(){
    console.log('user disconnected');
  });
});
